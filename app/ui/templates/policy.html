{% extends "base.html" %}
{% block title %}Guardrail Admin Â· Policy{% endblock %}

{% block content %}
<section class="container" style="max-width: 900px; margin: 2rem auto;">
  <h1>Policy</h1>
  <p class="muted">View the active policy version (from merged packs) and reload if packs change.</p>

  <div class="card" style="padding: 1rem 1.25rem; margin-top: 1rem;">
    <h2 style="margin-top:0;">Active Version</h2>
    <div id="versionBox"
         style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all; background:#f9fafb; border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem;">
      {{ version }}
    </div>
    <details style="margin-top:.75rem;">
      <summary><strong>Packs</strong></summary>
      <ul>
        {% for p in packs %}
        <li>{{ p }}</li>
        {% endfor %}
      </ul>
    </details>

    <div style="margin-top:1rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      <label>
        <span style="display:block; font-size:.9rem; color:#555;">Admin key (optional)</span>
        <input id="adminKey" type="password" placeholder="Only if RBAC is enabled"
               style="min-width: 260px; padding:.45rem .6rem; border:1px solid #d1d5db; border-radius:.5rem;">
      </label>

      <button id="reloadBtn" class="btn primary">Reload Policy</button>
      <span id="statusMsg" class="muted" style="margin-left:.5rem;"></span>
    </div>
    <pre id="policy_reload_msg" class="muted" style="white-space:pre-wrap;margin-top:.5rem;"></pre>
    <details style="margin-top:8px;">
      <summary><strong>Policy Diff (current â†’ candidate)</strong></summary>
      <pre id="policy_diff" class="muted" style="white-space:pre-wrap;"></pre>
    </details>
    <details style="margin-top:8px;">
      <summary><strong>Lint Results</strong> <span id="lint_summary" class="muted"></span></summary>
      <ul id="lint_list"></ul>
    </details>
  </div>

  <div class="card" style="padding: 1rem 1.25rem; margin-top: 1.5rem;">
    <strong>Validate Pack</strong>
    <p class="muted">Paste a YAML pack to lint before upload/activation.</p>
    <textarea id="pack_text" rows="8" style="width:100%;"></textarea>
    <button id="btn_validate" class="badge" style="margin-top:6px;">Validate</button>
    <pre id="validate_out"
         style="white-space:pre-wrap;background:#0b1020;color:#e5e7eb;padding:8px;border-radius:8px;max-height:240px;overflow:auto;"></pre>
  </div>
</section>

<style>
  .btn { padding:.5rem .85rem; border-radius:.5rem; border:1px solid #ccc; background:#f6f6f6; cursor:pointer; }
  .btn.primary { background:#2563eb; border-color:#2563eb; color:white; }
  .muted { color:#666; }
  .card { border:1px solid #e5e7eb; border-radius:.75rem; background:white; }
</style>

<script>
  (function () {
    const btn = document.getElementById('reloadBtn');
    const msg = document.getElementById('statusMsg');
    const vbox = document.getElementById('versionBox');
    const adminKey = document.getElementById('adminKey');
    const validateBtn = document.getElementById('btn_validate');
    const packInput = document.getElementById('pack_text');
    const validateOut = document.getElementById('validate_out');
    const reloadOut = document.getElementById('policy_reload_msg');
    const diffOut = document.getElementById('policy_diff');
    const lintSummary = document.getElementById('lint_summary');
    const lintList = document.getElementById('lint_list');
    const csrf = {{ csrf_token|tojson }};

    function renderLints(lints) {
      if (!lintList || !lintSummary) return;
      const items = Array.isArray(lints) ? lints : [];
      lintList.innerHTML = items.map((x) => {
        const sev = x.severity || 'info';
        const tag = sev === 'error' ? 'ðŸ”´' : (sev === 'warn' ? 'ðŸŸ ' : 'ðŸ”µ');
        const where = x.path ? ` <code>${x.path}</code>` : '';
        const rid = x.rule_id ? ` [${x.rule_id}]` : '';
        return `<li>${tag} <strong>${x.code}</strong>${rid}${where}: ${x.message}</li>`;
      }).join('');
      const counts = items.reduce((acc, lint) => {
        const key = lint.severity || 'info';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      lintSummary.textContent = `errors: ${counts.error || 0}, warnings: ${counts.warn || 0}, info: ${counts.info || 0}`;
    }

    function renderDiff(diff) {
      if (!diffOut) return;
      try {
        diffOut.textContent = JSON.stringify(diff, null, 2);
      } catch (err) {
        diffOut.textContent = '';
      }
    }

    async function previewDiff() {
      if (!diffOut) return;
      diffOut.textContent = 'Loading diff...';
      try {
        const headers = {};
        const key = (adminKey && adminKey.value || '').trim();
        if (key) headers['X-Admin-Key'] = key;
        const res = await fetch('/admin/api/policy/diff', {
          method: 'GET',
          headers,
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (!res.ok) {
          diffOut.textContent = `Failed to load diff (${res.status})`;
          return;
        }
        renderDiff(data && data.diff ? data.diff : {});
      } catch (err) {
        diffOut.textContent = 'Failed to load diff';
      }
    }

    async function reload() {
      msg.textContent = 'Reloading...';
      try {
        const headers = { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf };
        const key = (adminKey && adminKey.value || '').trim();
        if (key) headers['X-Admin-Key'] = key;

        const res = await fetch('/admin/api/policy/reload', {
          method: 'POST',
          headers,
          body: JSON.stringify({ csrf_token: csrf })
        });

        const bodyText = await res.text();
        let data = null;
        try {
          data = bodyText ? JSON.parse(bodyText) : null;
        } catch (err) {
          data = null;
        }

        renderLints(data && data.lints ? data.lints : []);

        if (reloadOut) {
          if (data && data.validation) {
            const issues = Array.isArray(data.validation.issues) ? data.validation.issues : [];
            const mode = data.validation.enforcement_mode || 'warn';
            const lines = issues.map((i) => {
              const sev = String(i.severity || '').toUpperCase();
              const code = i.code ? `[${i.code}]` : '';
              const loc = i.path ? `${i.path}: ` : '';
              return `${sev} ${code} ${loc}${i.message || ''}`.trim();
            });
            const summary = `${res.status} ${data.status || res.statusText || ''} (mode=${mode})`;
            const text = [summary, ...lines.filter(Boolean)].join('\n');
            reloadOut.textContent = text.trim();
          } else {
            const summary = `${res.status} ${res.statusText || ''}`;
            reloadOut.textContent = bodyText ? `${summary}\n${bodyText}`.trim() : summary;
          }
        }

        if (!res.ok) {
          msg.textContent = `Failed (${res.status}): ${bodyText || 'error'}`;
          if (data && data.diff) {
            renderDiff(data.diff);
          }
          return;
        }

        if (data) {
          const resultVersion = data.version || (data.result && data.result.version);
          if (resultVersion) {
            vbox.textContent = resultVersion;
          }
          if (data.diff) {
            renderDiff(data.diff);
          }
        }

        // Fetch packs/version again to keep in sync (optional)
        const vres = await fetch('/admin/api/policy/version');
        if (vres.ok) {
          const vj = await vres.json();
          vbox.textContent = vj.version || vbox.textContent;
        }

        msg.textContent = 'Reloaded.';
        setTimeout(() => { msg.textContent = ''; }, 2000);
      } catch (e) {
        msg.textContent = 'Error reloading.';
        renderLints([]);
      }
      previewDiff();
    }

    async function validatePack() {
      if (!validateOut) return;
      validateOut.textContent = 'Validating...';
      try {
        const headers = { 'Content-Type': 'application/json' };
        const key = (adminKey && adminKey.value || '').trim();
        if (key) headers['X-Admin-Key'] = key;
        const payload = { yaml: packInput ? packInput.value : '' };
        const res = await fetch('/admin/api/policy/validate', {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        const ok = data.status === 'ok';
        const lines = (data.issues || []).map((i) => {
          const loc = i.path ? `${i.path}: ` : '';
          return `${String(i.severity || '').toUpperCase()} [${i.code}] ${loc}${i.message}`;
        });
        validateOut.textContent = `${ok ? 'OK' : 'FAIL'}\n${lines.join('\n')}`;
        renderLints(data && data.lints ? data.lints : []);
      } catch (err) {
        validateOut.textContent = 'Validation failed.';
        renderLints([]);
      }
    }

    if (btn) btn.addEventListener('click', reload);
    if (validateBtn) validateBtn.addEventListener('click', validatePack);
    document.addEventListener('DOMContentLoaded', () => {
      renderLints([]);
      previewDiff();
    });
  })();
</script>
{% endblock %}
