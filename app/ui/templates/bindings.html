{% extends "base.html" %}
{% block content %}
<div
  class="card"
  id="bindings-card"
  data-tenant="{{ tenant or '' }}"
  data-bot="{{ bot or '' }}"
>
  <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
    <h2 style="margin:0;">Bindings</h2>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
      {% if enable_golden_one_click %}
      <button
        type="button"
        id="apply-golden-button"
        {% if not (tenant and bot) %}disabled{% endif %}
      >
        Apply Golden Packs
      </button>
      {% endif %}
      <button type="button" id="apply-strict-button">Apply Strict Secrets Pack</button>
      <button type="button" id="apply-demo-button">Apply Demo Defaults</button>
    </div>
  </div>
  {% if enable_golden_one_click %}
  <div id="apply-golden-toast" class="banner success" role="status" aria-live="polite" hidden></div>
  <div id="apply-golden-error" class="banner error" role="alert" hidden></div>
  {% endif %}
  <div id="apply-strict-alert" class="banner info" role="status" aria-live="polite" hidden></div>
  <div id="apply-demo-alert" class="banner info" role="status" aria-live="polite" hidden></div>
  <table id="bindings-table" {% if not bindings or bindings|length == 0 %}style="display:none"{% endif %}>
    <thead><tr><th>Tenant</th><th>Bot</th><th>Policy</th></tr></thead>
    <tbody id="bindings-table-body">
      {% for b in bindings %}
      <tr><td>{{ b.tenant }}</td><td>{{ b.bot }}</td><td>{{ b.policy_version or '—' }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <p id="bindings-empty" class="muted" {% if bindings and bindings|length > 0 %}style="display:none"{% endif %}>No bindings found.</p>
</div>

{% if enable_golden_one_click %}
<div
  id="apply-golden-dialog"
  class="golden-modal"
  role="dialog"
  aria-modal="true"
  hidden
>
  <div class="golden-modal-body">
    <h3 style="margin-top:0;">Apply Golden Packs</h3>
    <p>Apply Golden Packs to <strong id="apply-golden-target"></strong>?</p>
    <p class="muted">This action will bind the following policy packs:</p>
    <ul class="golden-pack-list">
      <li>pii_redact</li>
      <li>secrets_redact</li>
    </ul>
    <p class="muted">Reapplying will also refresh in-memory caches.</p>
    <div class="golden-modal-actions">
      <button type="button" id="apply-golden-confirm">Apply</button>
      <button type="button" id="apply-golden-cancel">Cancel</button>
    </div>
  </div>
</div>
{% endif %}

<div
  class="card"
  id="mitigation-modes-card"
  data-tenant="{{ tenant or '' }}"
  data-bot="{{ bot or '' }}"
>
  <h3 style="margin-top:0;">Mitigation modes</h3>
  <p class="muted" id="mitigation-context"></p>
  <div id="mitigation-error" class="banner error" role="alert" hidden></div>
  <div
    id="mitigation-toast"
    class="banner success"
    role="status"
    aria-live="polite"
    hidden
  ></div>
  <div class="toggle-list">
    <label class="toggle-item">
      <input
        type="checkbox"
        id="mitigation-mode-block"
        {% if mitigation_modes.block %}checked{% endif %}
      />
      <span class="toggle-copy">
        <strong>Block</strong>
        <span class="muted">Enforced in decision path.</span>
      </span>
    </label>
    <label class="toggle-item">
      <input
        type="checkbox"
        id="mitigation-mode-redact"
        {% if mitigation_modes.redact %}checked{% endif %}
      />
      <span class="toggle-copy">
        <strong>Redact</strong>
        <span class="muted">Stored &amp; returned; observability-focused.</span>
      </span>
    </label>
    <label class="toggle-item">
      <input
        type="checkbox"
        id="mitigation-mode-clarify"
        {% if mitigation_modes.clarify_first %}checked{% endif %}
      />
      <span class="toggle-copy">
        <strong>Clarify-first</strong>
        <span class="muted">Stored &amp; returned; observability-focused.</span>
      </span>
    </label>
  </div>
  <p id="mitigation-saving" class="muted" hidden></p>
</div>
{% if enable_golden_one_click %}
<style>
  #apply-golden-button[disabled] {
    cursor: not-allowed;
    opacity: 0.6;
  }
  .golden-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: rgba(17, 24, 39, 0.45);
    z-index: 40;
  }
  .golden-modal[hidden] {
    display: none;
  }
  .golden-modal-body {
    background: #fff;
    border-radius: 0.75rem;
    padding: 1.25rem;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
  }
  .golden-modal-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    justify-content: flex-end;
    flex-wrap: wrap;
  }
  .golden-pack-list {
    margin: 0.75rem 0;
    padding-left: 1.25rem;
  }
  .golden-pack-list li {
    margin-bottom: 0.25rem;
  }
</style>
{% endif %}

<script>
  (function () {
    function getCookie(name) {
      return (document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)') || [])[2];
    }

    function normalizedPolicyVersion(value) {
      const text = (value || '').trim();
      return text === '—' ? '' : text;
    }

    const bindingsCard = document.getElementById('bindings-card');
    const table = document.getElementById('bindings-table');
    const tbody = document.getElementById('bindings-table-body');
    const emptyState = document.getElementById('bindings-empty');

    const goldenButton = document.getElementById('apply-golden-button');
    const goldenDialog = document.getElementById('apply-golden-dialog');
    const goldenConfirm = document.getElementById('apply-golden-confirm');
    const goldenCancel = document.getElementById('apply-golden-cancel');
    const goldenToast = document.getElementById('apply-golden-toast');
    const goldenError = document.getElementById('apply-golden-error');
    const goldenTarget = document.getElementById('apply-golden-target');

    const strictButton = document.getElementById('apply-strict-button');
    const demoButton = document.getElementById('apply-demo-button');
    const strictAlert = document.getElementById('apply-strict-alert');
    const demoAlert = document.getElementById('apply-demo-alert');

    const contextTenant = bindingsCard ? bindingsCard.getAttribute('data-tenant') || '' : '';
    const contextBot = bindingsCard ? bindingsCard.getAttribute('data-bot') || '' : '';
    const canApplyQuick = Boolean(contextTenant && contextBot);

    let quickLoading = false;
    let goldenLoading = false;

    function setBanner(element, kind, message) {
      if (!element) {
        return;
      }
      if (!message) {
        element.hidden = true;
        element.textContent = '';
        element.className = 'banner';
        return;
      }
      element.className = 'banner ' + kind;
      element.textContent = message;
      element.hidden = false;
    }

    function findPolicyVersionFromTable(tenant, bot) {
      if (!tbody) {
        return '';
      }
      const rows = tbody.querySelectorAll('tr');
      for (let i = 0; i < rows.length; i += 1) {
        const cells = rows[i].querySelectorAll('td');
        if (cells.length < 3) {
          continue;
        }
        const rowTenant = (cells[0].textContent || '').trim();
        const rowBot = (cells[1].textContent || '').trim();
        if (rowTenant === tenant && rowBot === bot) {
          return (cells[2].textContent || '').trim();
        }
      }
      return '';
    }

    function captureBindingSnapshot(tenant, bot) {
      const policy = normalizedPolicyVersion(findPolicyVersionFromTable(tenant, bot));
      const storedPolicy = bindingsCard ? bindingsCard.getAttribute('data-golden-policy-version') || '' : '';
      const storedVersion = bindingsCard ? bindingsCard.getAttribute('data-golden-version') || '' : '';
      return {
        policyVersion: policy || storedPolicy,
        version: storedVersion
      };
    }

    function updateBindings(list) {
      if (!tbody) {
        return;
      }
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }
      if (list && list.length) {
        list.forEach(function (item) {
          const tr = document.createElement('tr');
          const tdTenant = document.createElement('td');
          tdTenant.textContent = item.tenant || '';
          const tdBot = document.createElement('td');
          tdBot.textContent = item.bot || '';
          const tdPolicy = document.createElement('td');
          tdPolicy.textContent = item.policy_version || '—';
          tr.appendChild(tdTenant);
          tr.appendChild(tdBot);
          tr.appendChild(tdPolicy);
          tbody.appendChild(tr);
        });
        if (table) {
          table.style.display = '';
        }
        if (emptyState) {
          emptyState.style.display = 'none';
        }
      } else {
        if (table) {
          table.style.display = 'none';
        }
        if (emptyState) {
          emptyState.style.display = '';
        }
      }
      if (bindingsCard) {
        const policy = normalizedPolicyVersion(findPolicyVersionFromTable(contextTenant, contextBot));
        bindingsCard.setAttribute('data-golden-policy-version', policy);
      }
    }

    function refreshBindings() {
      return fetch('/admin/ui/bindings/data', { credentials: 'same-origin' })
        .then(function (res) {
          return res.json();
        })
        .then(function (data) {
          if (data && data.bindings) {
            updateBindings(data.bindings);
          }
        })
        .catch(function () {
          // no-op
        });
    }

    function showGoldenToast(kind, message) {
      if (!goldenToast) {
        return;
      }
      if (!message) {
        goldenToast.hidden = true;
        goldenToast.textContent = '';
        goldenToast.className = 'banner';
        return;
      }
      goldenToast.className = 'banner ' + kind;
      goldenToast.textContent = message;
      goldenToast.hidden = false;
    }

    function showGoldenError(message) {
      if (!goldenError) {
        return;
      }
      if (!message) {
        goldenError.hidden = true;
        goldenError.textContent = '';
        return;
      }
      goldenError.textContent = message;
      goldenError.hidden = false;
    }

    function applyGoldenButtonState() {
      if (!goldenButton) {
        return;
      }
      const disabled = !canApplyQuick || quickLoading || goldenLoading;
      goldenButton.disabled = disabled;
    }

    function setGoldenLoading(isLoading) {
      goldenLoading = isLoading;
      applyGoldenButtonState();
      if (goldenConfirm) {
        goldenConfirm.disabled = isLoading;
      }
    }

    function closeGoldenDialog() {
      if (goldenDialog) {
        goldenDialog.hidden = true;
      }
    }

    function openGoldenDialog() {
      if (!goldenDialog) {
        return;
      }
      if (goldenTarget) {
        goldenTarget.textContent = contextTenant + '/' + contextBot;
      }
      goldenDialog.hidden = false;
      if (goldenConfirm) {
        goldenConfirm.disabled = false;
        goldenConfirm.focus();
      }
    }

    function setQuickButtonsLoading(isLoading) {
      quickLoading = isLoading;
      if (strictButton) {
        strictButton.disabled = isLoading || !canApplyQuick;
      }
      if (demoButton) {
        demoButton.disabled = isLoading || !canApplyQuick;
      }
      applyGoldenButtonState();
    }

    function bindQuickAction(options) {
      const buttonEl = options.button;
      const alertEl = options.alert;
      if (!buttonEl || !alertEl) {
        return;
      }
      buttonEl.addEventListener('click', function () {
        if (!canApplyQuick) {
          return;
        }
        const confirmMessage =
          typeof options.confirmMessage === 'function'
            ? options.confirmMessage(contextTenant, contextBot)
            : options.confirmMessage;
        if (confirmMessage && !window.confirm(confirmMessage)) {
          return;
        }
        setBanner(alertEl, 'info', options.pendingMessage);
        setQuickButtonsLoading(true);

        fetch(options.endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            tenant: contextTenant,
            bot: contextBot,
            csrf_token: getCookie('ui_csrf') || ''
          })
        })
          .then(function (res) {
            return res
              .json()
              .catch(function () {
                return {};
              })
              .then(function (body) {
                return { ok: res.ok, body: body };
              });
          })
          .then(function (result) {
            if (!result.ok) {
              const detail =
                result.body &&
                (result.body.detail ||
                  result.body.message ||
                  result.body.error ||
                  result.body.error_message);
              setBanner(alertEl, 'error', detail || options.errorMessage);
              return;
            }
            const status =
              result.body.status || (result.body.applied ? options.successStatus || 'success' : 'info');
            const message =
              result.body.message ||
              (result.body.applied
                ? options.successMessage(contextTenant, contextBot)
                : options.alreadyMessage);
            setBanner(alertEl, status, message);
            if (result.body && result.body.bindings) {
              updateBindings(result.body.bindings);
            } else {
              refreshBindings();
            }
          })
          .catch(function () {
            setBanner(alertEl, 'error', options.errorMessage);
          })
          .finally(function () {
            setQuickButtonsLoading(false);
          });
      });
    }

    if (bindingsCard && !bindingsCard.getAttribute('data-golden-version')) {
      bindingsCard.setAttribute('data-golden-version', '');
    }
    if (bindingsCard) {
      const initialPolicy = normalizedPolicyVersion(findPolicyVersionFromTable(contextTenant, contextBot));
      bindingsCard.setAttribute('data-golden-policy-version', initialPolicy);
    }

    applyGoldenButtonState();
    setQuickButtonsLoading(false);

    if (goldenButton) {
      goldenButton.addEventListener('click', function () {
        if (!canApplyQuick) {
          return;
        }
        showGoldenError('');
        openGoldenDialog();
      });
    }

    if (goldenCancel) {
      goldenCancel.addEventListener('click', function () {
        closeGoldenDialog();
      });
    }

    if (goldenDialog) {
      goldenDialog.addEventListener('click', function (evt) {
        if (evt.target === goldenDialog) {
          closeGoldenDialog();
        }
      });
    }

    if (goldenConfirm) {
      goldenConfirm.addEventListener('click', function () {
        if (!canApplyQuick) {
          return;
        }
        const csrfToken = getCookie('ui_csrf') || '';
        const previous = captureBindingSnapshot(contextTenant, contextBot);
        setGoldenLoading(true);
        showGoldenError('');
        showGoldenToast('info', '');

        fetch('/admin/ui/bindings/apply_golden', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            tenant: contextTenant,
            bot: contextBot,
            csrf_token: csrfToken
          })
        })
          .then(function (res) {
            return res
              .json()
              .catch(function () {
                return {};
              })
              .then(function (body) {
                return { ok: res.ok, body: body };
              });
          })
          .then(function (result) {
            if (!result.ok) {
              const detail =
                result.body && (result.body.detail || result.body.message || result.body.error);
              showGoldenError(detail || 'Failed to apply Golden Packs.');
              return;
            }
            const binding =
              (result.body && result.body.binding) || result.body || {};
            const applied = Boolean(binding.applied);
            const newPolicy = normalizedPolicyVersion(binding.policy_version || '');
            const newVersion = binding.version || '';
            let toastKind = applied ? 'success' : 'info';
            let toastMessage;
            if (applied) {
              toastMessage = 'Applied Golden Packs to ' + contextTenant + '/' + contextBot + '.';
            } else if (
              (newPolicy && newPolicy !== (previous.policyVersion || '')) ||
              (newVersion && newVersion !== (previous.version || ''))
            ) {
              toastKind = 'success';
              toastMessage = 'Refreshed Golden Packs for ' + contextTenant + '/' + contextBot + '.';
            } else {
              toastMessage = 'Already up-to-date for ' + contextTenant + '/' + contextBot + '.';
            }
            const details = [
              'applied: ' + String(applied),
              'rules_path: ' + (binding.rules_path || '—'),
              'version: ' + (newVersion || '—'),
              'policy_version: ' + (newPolicy || '—')
            ].join(' · ');
            showGoldenToast(toastKind, toastMessage + ' — ' + details);
            if (bindingsCard) {
              bindingsCard.setAttribute('data-golden-policy-version', newPolicy);
              bindingsCard.setAttribute('data-golden-version', newVersion);
            }
            if (result.body && result.body.bindings) {
              updateBindings(result.body.bindings);
            } else {
              refreshBindings();
            }
            closeGoldenDialog();
          })
          .catch(function () {
            showGoldenError('Failed to apply Golden Packs.');
          })
          .finally(function () {
            setGoldenLoading(false);
          });
      });
    }

    bindQuickAction({
      button: strictButton,
      alert: strictAlert,
      endpoint: '/admin/ui/bindings/apply_strict_secrets',
      pendingMessage: 'Applying Strict Secrets Pack…',
      confirmMessage: function (tenant, bot) {
        return 'Apply Strict Secrets Pack to ' + tenant + '/' + bot + '?';
      },
      successMessage: function (tenant, bot) {
        return 'Applied to ' + tenant + '/' + bot + '.';
      },
      alreadyMessage: 'Already applied; refreshed caches.',
      errorMessage: 'Failed to apply Strict Secrets Pack.'
    });

    bindQuickAction({
      button: demoButton,
      alert: demoAlert,
      endpoint: '/admin/ui/bindings/apply_demo_defaults',
      pendingMessage: 'Applying Demo Defaults…',
      confirmMessage: function (tenant, bot) {
        return 'Apply Demo Defaults to ' + tenant + '/' + bot + '?';
      },
      successMessage: function (tenant, bot) {
        return 'Applied to ' + tenant + '/' + bot + '.';
      },
      alreadyMessage: 'Already applied; refreshed caches.',
      errorMessage: 'Failed to apply Demo Defaults.'
    });

    const mitigationCard = document.getElementById('mitigation-modes-card');
    if (mitigationCard) {
      const tenant = mitigationCard.getAttribute('data-tenant') || '';
      const bot = mitigationCard.getAttribute('data-bot') || '';
      const context = document.getElementById('mitigation-context');
      const errorBanner = document.getElementById('mitigation-error');
      const toastBanner = document.getElementById('mitigation-toast');
      const savingNote = document.getElementById('mitigation-saving');
      const blockToggle = document.getElementById('mitigation-mode-block');
      const redactToggle = document.getElementById('mitigation-mode-redact');
      const clarifyToggle = document.getElementById('mitigation-mode-clarify');
      const toggles = [blockToggle, redactToggle, clarifyToggle].filter(Boolean);
      const hasPair = Boolean(tenant && bot);
      let toastTimer = null;

      if (context) {
        context.textContent = hasPair
          ? tenant + '/' + bot
          : 'Provide tenant and bot to manage mitigation modes.';
      }

      function setControlsDisabled(disabled) {
        toggles.forEach(function (input) {
          if (!input) {
            return;
          }
          input.disabled = !hasPair || disabled;
        });
      }

      function setSavingIndicator(message) {
        if (!savingNote) {
          return;
        }
        if (!message) {
          savingNote.hidden = true;
          savingNote.textContent = '';
        } else {
          savingNote.hidden = false;
          savingNote.textContent = message;
        }
      }

      function setError(message) {
        if (!errorBanner) {
          return;
        }
        if (!message) {
          errorBanner.hidden = true;
          errorBanner.textContent = '';
        } else {
          errorBanner.textContent = message;
          errorBanner.hidden = false;
        }
      }

      function clearToastTimer() {
        if (toastTimer) {
          clearTimeout(toastTimer);
          toastTimer = null;
        }
      }

      function setToast(message) {
        if (!toastBanner) {
          return;
        }
        clearToastTimer();
        if (!message) {
          toastBanner.hidden = true;
          toastBanner.textContent = '';
          return;
        }
        toastBanner.textContent = message;
        toastBanner.hidden = false;
        toastTimer = setTimeout(function () {
          toastBanner.hidden = true;
          toastBanner.textContent = '';
        }, 3500);
      }

      function applyModes(modes) {
        if (!modes) {
          return;
        }
        if (blockToggle) {
          blockToggle.checked = Boolean(modes.block);
        }
        if (redactToggle) {
          redactToggle.checked = Boolean(modes.redact);
        }
        if (clarifyToggle) {
          clarifyToggle.checked = Boolean(modes.clarify_first);
        }
      }

      function currentModes() {
        return {
          block: Boolean(blockToggle && blockToggle.checked),
          redact: Boolean(redactToggle && redactToggle.checked),
          clarify_first: Boolean(clarifyToggle && clarifyToggle.checked)
        };
      }

      function fetchModes() {
        if (!hasPair) {
          setControlsDisabled(true);
          return;
        }
        setControlsDisabled(true);
        setSavingIndicator('Loading…');
        setError('');
        fetch(
          '/admin/mitigation_modes?tenant=' +
            encodeURIComponent(tenant) +
            '&bot=' +
            encodeURIComponent(bot),
          { credentials: 'same-origin' }
        )
          .then(function (res) {
            return res
              .json()
              .catch(function () {
                return {};
              })
              .then(function (body) {
                return { ok: res.ok, body: body };
              });
          })
          .then(function (result) {
            if (!result.ok) {
              const detail =
                result.body && (result.body.detail || result.body.error || result.body.message);
              setError(detail || 'Failed to load mitigation modes.');
              return;
            }
            setError('');
            if (result.body && result.body.modes) {
              applyModes(result.body.modes);
            }
          })
          .catch(function () {
            setError('Failed to load mitigation modes.');
          })
          .finally(function () {
            setSavingIndicator('');
            setControlsDisabled(false);
          });
      }

      function saveModes() {
        if (!hasPair) {
          return;
        }
        setControlsDisabled(true);
        setSavingIndicator('Saving…');
        setError('');
        const payload = {
          tenant: tenant,
          bot: bot,
          modes: currentModes()
        };
        fetch('/admin/mitigation_modes', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        })
          .then(function (res) {
            return res
              .json()
              .catch(function () {
                return {};
              })
              .then(function (body) {
                return { ok: res.ok, body: body };
              });
          })
          .then(function (result) {
            if (!result.ok) {
              const detail =
                result.body && (result.body.detail || result.body.error || result.body.message);
              setError(detail || 'Failed to save mitigation modes.');
              return;
            }
            setError('');
            if (result.body && result.body.modes) {
              applyModes(result.body.modes);
            }
            setSavingIndicator('');
            setToast('Saved mitigation modes for ' + tenant + '/' + bot);
          })
          .catch(function () {
            setError('Failed to save mitigation modes.');
          })
          .finally(function () {
            setControlsDisabled(false);
          });
      }

      if (!hasPair) {
        setControlsDisabled(true);
        setSavingIndicator('');
      } else {
        toggles.forEach(function (input) {
          if (!input) {
            return;
          }
          input.addEventListener('change', function () {
            saveModes();
          });
        });
        fetchModes();
      }
    }

    updateBindings({{ (bindings or []) | tojson }});
  })();
</script>

{% endblock %}

