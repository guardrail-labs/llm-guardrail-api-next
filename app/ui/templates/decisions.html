<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Guardrail Decisions</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
      form.filters { display: grid; grid-template-columns: repeat(5, minmax(160px, 1fr)); gap: 8px; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align: left; font-size: 14px; }
      th { background: #f9fafb; position: sticky; top: 0; }
      .controls { display: flex; gap: 8px; align-items: center; margin: 12px 0; }
      input, select { padding: 6px 8px; font-size: 14px; }
      button { padding: 6px 10px; font-size: 14px; cursor: pointer; }
      .muted { color: #6b7280; }
      .badge { border-radius: 999px; padding: 2px 8px; font-size: 12px; background: #eef2ff; color: #3730a3; }
      .outcome-allow { background: #ecfdf5; color: #065f46; }
      .outcome-block_input_only { background: #fff7ed; color: #9a3412; }
      .outcome-execute_locked, .outcome-full_quarantine { background: #fee2e2; color: #991b1b; }
      .nowrap { white-space: nowrap; }
    </style>
  </head>
  <body>
    {% include "_admin_nav.html" %}
    <div class="card">
      <h3>Decisions</h3>
      <form id="filters" onsubmit="return false" style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
        <label>Since (ISO8601 UTC)
          <input type="text" id="f_since" placeholder="2025-09-15T00:00:00Z">
        </label>
        <label>Tenant
          <input type="text" id="f_tenant" placeholder="tenant">
        </label>
        <label>Bot
          <input type="text" id="f_bot" placeholder="bot">
        </label>
        <label>Outcome
          <input type="text" id="f_outcome" placeholder="allow|block_input_only|redact|rate_limit">
        </label>
        <label>Page size
          <input type="number" id="f_pagesize" min="1" max="500" value="50">
        </label>
        <button id="btn_apply" class="badge">Apply</button>
        <button id="btn_reset" class="badge muted" type="button">Reset</button>
        <a class="badge" id="btn_csv" href="#">Export CSV</a>
        <a class="badge" id="btn_ndjson" href="#">NDJSON</a>
      </form>

      <table id="tbl" class="table" style="margin-top:8px; width:100%;">
        <thead>
          <tr>
            <th data-k="ts">ts</th>
            <th data-k="tenant">tenant</th>
            <th data-k="bot">bot</th>
            <th data-k="outcome">outcome</th>
            <th data-k="policy_version">policy_version</th>
            <th data-k="rule_id">rule_id</th>
            <th data-k="incident_id">incident_id</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="prev" class="badge">&laquo; Prev</button>
        <span id="pageinfo"></span>
        <button id="next" class="badge">Next &raquo;</button>
      </div>

      <pre id="status" class="muted" style="white-space:pre-wrap; margin-top:8px;"></pre>
    </div>

    <script>
(function(){
  const qs = new URLSearchParams(location.search);
  const S = {
    page: +(qs.get("page") || 1),
    page_size: +(qs.get("page_size") || 50),
    since: qs.get("since") || "",
    tenant: qs.get("tenant") || "",
    bot: qs.get("bot") || "",
    outcome: qs.get("outcome") || "",
    sortKey: qs.get("sort") || "ts",
    sortDir: qs.get("dir") || "desc", // asc|desc
  };

  const $ = (id) => document.getElementById(id);
  const $tbody = document.querySelector("#tbl tbody");
  const $pageinfo = $("pageinfo");
  const $status = $("status");

  $("f_since").value = S.since;
  $("f_tenant").value = S.tenant;
  $("f_bot").value = S.bot;
  $("f_outcome").value = S.outcome;
  $("f_pagesize").value = S.page_size;

  function toParams(overrides={}) {
    const p = new URLSearchParams({
      page: String(S.page),
      page_size: String(S.page_size),
    });
    if (S.since) p.set("since", S.since);
    if (S.tenant) p.set("tenant", S.tenant);
    if (S.bot) p.set("bot", S.bot);
    if (S.outcome) p.set("outcome", S.outcome);
    if (S.sortKey) p.set("sort", S.sortKey);
    if (S.sortDir) p.set("dir", S.sortDir);
    for (const [k,v] of Object.entries(overrides)) {
      if (v === null) p.delete(k);
      else p.set(k, v);
    }
    return p;
  }

  function applyToUrl() {
    const p = toParams();
    history.replaceState(null, "", "?" + p.toString());
  }

  async function load() {
    applyToUrl();
    const p = toParams();
    const u = "/admin/api/decisions?" + p.toString();
    const r = await fetch(u, {credentials:"same-origin"});
    const data = await r.json();
    const items = (data.items || []);
    // client-side sort for the current page (server API has fixed order)
    items.sort((a,b) => {
      const k = S.sortKey;
      let va = a[k], vb = b[k];
      if (k === "ts") { va = new Date(va).getTime(); vb = new Date(vb).getTime(); }
      if (va < vb) return S.sortDir === "asc" ? -1 : 1;
      if (va > vb) return S.sortDir === "asc" ? 1 : -1;
      return 0;
    });
    $tbody.innerHTML = items.map(row => `
      <tr>
        <td>${row.ts ?? ""}</td>
        <td>${row.tenant ?? ""}</td>
        <td>${row.bot ?? ""}</td>
        <td>${row.outcome ?? ""}</td>
        <td>${row.policy_version ?? ""}</td>
        <td>${row.rule_id ?? ""}</td>
        <td>${row.incident_id ?? ""}</td>
      </tr>
    `).join("");
    const total = data.total ?? (S.page * S.page_size); // fallback
    $pageinfo.textContent = `Page ${S.page} (size ${S.page_size})`;
    $status.textContent = `Loaded ${items.length} / total ~${total}\n`;
    // wire export buttons
    const exportParams = toParams(); exportParams.delete("page"); exportParams.delete("page_size");
    $("btn_csv").href = "/admin/api/decisions/export.csv?" + exportParams.toString();
    $("btn_ndjson").href = "/admin/api/decisions/export.ndjson?" + exportParams.toString();
  }

  $("btn_apply").addEventListener("click", () => {
    S.page = 1;
    S.page_size = +$("f_pagesize").value || 50;
    S.since = $("f_since").value.trim();
    S.tenant = $("f_tenant").value.trim();
    S.bot = $("f_bot").value.trim();
    S.outcome = $("f_outcome").value.trim();
    load();
  });

  $("btn_reset").addEventListener("click", () => {
    S.page = 1; S.page_size = 50; S.since = ""; S.tenant=""; S.bot=""; S.outcome="";
    $("f_since").value = $("f_tenant").value = $("f_bot").value = $("f_outcome").value = "";
    $("f_pagesize").value = "50";
    load();
  });

  $("prev").addEventListener("click", () => {
    if (S.page > 1) { S.page -= 1; load(); }
  });
  $("next").addEventListener("click", () => {
    S.page += 1; load();
  });

  // clickable header sorting (current page only)
  document.querySelectorAll("#tbl th[data-k]").forEach(th => {
    th.style.cursor = "pointer";
    th.addEventListener("click", () => {
      const k = th.getAttribute("data-k");
      if (S.sortKey === k) {
        S.sortDir = (S.sortDir === "asc" ? "desc" : "asc");
      } else {
        S.sortKey = k; S.sortDir = "asc";
      }
      load();
    });
  });

  // initial load with restored state from URL
  if (qs.get("page")) S.page = +qs.get("page");
  if (qs.get("page_size")) S.page_size = +qs.get("page_size");
  load();
})();
    </script>
  </body>
</html>
