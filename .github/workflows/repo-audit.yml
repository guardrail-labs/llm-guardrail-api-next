name: Repo Audit

on:
  workflow_dispatch: {}

permissions:
  contents: read  # workflow-level default; safe for checkout

jobs:
  audit:
    name: Run read-only audit
    runs-on: ubuntu-latest
    permissions:
      contents: read     # required by actions/checkout
      actions: write     # required by actions/upload-artifact@v4
    steps:
      - name: Checkout (read-only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install lightweight tools (best-effort)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ripgrep yamllint jq
          python3 -m pip install --upgrade pip || true
          python3 -m pip install pip-audit bandit vulture || true
          # --- Optional deep secret scanners (best-effort) ---
          # Install gitleaks
          curl -sSL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | bash || true
          # Install trufflehog (prefer pipx if available)
          if command -v pipx >/dev/null 2>&1; then
            pipx install trufflehog || true
          else
            python3 -m pip install trufflehog || true
          fi

      - name: Run audit (non-destructive)
        run: |
          chmod +x tools/ci/repo_audit.sh
          tools/ci/repo_audit.sh repo-audit-report.md

      - name: Run gitleaks (non-blocking)
        run: |
          if command -v gitleaks >/dev/null 2>&1; then
            # gitleaks exits non-zero when leaks are found; do NOT treat that as failure.
            # Force zero exit but still produce the JSON report.
            gitleaks detect --no-banner -v --report-format json --report-path gitleaks-report.json --exit-code 0 || true
            # If for some reason no report was produced, emit a skip marker.
            test -s gitleaks-report.json || echo '{"skipped": "gitleaks produced no report"}' > gitleaks-report.json
          else
            echo '{"skipped": "gitleaks not installed"}' > gitleaks-report.json
          fi

      - name: Run trufflehog (filesystem; non-blocking)
        run: |
          if command -v trufflehog >/dev/null 2>&1; then
            # trufflehog may exit 183 on findings; still capture JSON. Never overwrite a real report.
            trufflehog filesystem --no-update --json . > trufflehog-report.json || true
            test -s trufflehog-report.json || echo '{"skipped": "trufflehog produced no report"}' > trufflehog-report.json
          else
            echo '{"skipped": "trufflehog not installed"}' > trufflehog-report.json
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo-audit
          path: |
            repo-audit-report.md
            gitleaks-report.json
            trufflehog-report.json
          if-no-files-found: error
          retention-days: 14

      - name: Publish summary
        run: |
          echo "# Repo Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "_This run is read-only. See full details in the artifact._" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          head -n 300 repo-audit-report.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Secrets Scans (heads-up only)" >> $GITHUB_STEP_SUMMARY
          echo "- gitleaks: $(jq -r '.skipped // \"report generated\"' gitleaks-report.json 2>/dev/null || echo "report generated")" >> $GITHUB_STEP_SUMMARY
          echo "- trufflehog: $(jq -r '.skipped // \"report generated\"' trufflehog-report.json 2>/dev/null || echo "report generated")" >> $GITHUB_STEP_SUMMARY
