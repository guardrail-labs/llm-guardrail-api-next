name: Perf Smoke

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or SHA) to test"
        required: false
        default: main

permissions:
  contents: read
  actions: write

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pipx install uv

      - name: Sync deps (dev extras)
        run: |
          # Include optional dev dependencies (provides httpx for the bench script)
          uv sync --extra dev
          # Sanity: show installed httpx
          uv run python -c "import httpx,sys; print('httpx', httpx.__version__)"

      - name: Install runtime deps needed at import (PyJWT)
        run: |
          # app.security.service_tokens imports 'jwt' (PyJWT)
          uv pip install --quiet pyjwt
          uv run python -c "import jwt, sys; print('pyjwt OK')"

      - name: Start API (background)
        run: |
          set -euo pipefail
          # Start API with logs captured
          uv run uvicorn app.main:create_app --factory --host 127.0.0.1 --port 8000 > uvicorn.log 2>&1 &
          echo $! > uvicorn.pid
          # wait for healthz
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:8000/healthz >/dev/null; then
              echo "API is up"
              exit 0
            fi
            if ! kill -0 "$(cat uvicorn.pid)" 2>/dev/null; then
              echo "Uvicorn crashed during startup. Recent logs:"
              tail -n 200 uvicorn.log || true
              exit 1
            fi
            sleep 1
          done
          echo "API failed to start in time. Recent logs:"
          tail -n 200 uvicorn.log || true
          exit 1

      - name: Run perf bench
        run: |
          # Use --out if the script supports it; otherwise capture stdout
          if uv run python tools/perf/bench.py --help 2>/dev/null | grep -q -- '--out'; then
            # Prefer passing base URL if supported
            if uv run python tools/perf/bench.py --help 2>/dev/null | grep -q -- '--base'; then
              uv run python tools/perf/bench.py --base http://127.0.0.1:8000 --out perf-rc-candidate.json
            else
              BASE_URL=http://127.0.0.1:8000 uv run python tools/perf/bench.py --out perf-rc-candidate.json
            fi
          else
            if uv run python tools/perf/bench.py --help 2>/dev/null | grep -q -- '--base'; then
              uv run python tools/perf/bench.py --base http://127.0.0.1:8000 > perf-rc-candidate.json
            else
              BASE_URL=http://127.0.0.1:8000 uv run python tools/perf/bench.py > perf-rc-candidate.json
            fi
          fi
          test -s perf-rc-candidate.json || echo '{}' > perf-rc-candidate.json

      - name: Stop API
        if: always()
        run: |
          if [ -f uvicorn.pid ]; then kill "$(cat uvicorn.pid)" || true; fi
          pkill -f "uvicorn app.main:create_app" || true
          echo "::group::uvicorn.log (tail)"
          tail -n 300 uvicorn.log || true
          echo "::endgroup::"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-rc-candidate
          path: perf-rc-candidate.json
          if-no-files-found: error
          retention-days: 14
