{
  "uid": "guardrail-top-rules",
  "title": "Guardrail API — Top Rules",
  "timezone": "",
  "version": 1,
  "schemaVersion": 38,
  "tags": ["guardrail", "core"],
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": { "refresh_intervals": ["5s","10s","30s","1m","2m","5m"] },
  "refresh": "30s",
  "panels": [
    {
      "type": "bargauge",
      "title": "Top rule IDs (non-allow outcomes) — last $__rate_interval",
      "id": 10,
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
      "options": { "orientation": "horizontal", "displayMode": "lcd" },
      "targets": [
        {
          "expr": "topk(10, increase(guardrail_decisions_total{outcome!=\"allow\",rule_id!=\"\"}[$__rate_interval]))",
          "legendFormat": "{{rule_id}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "bargauge",
      "title": "Blocks by tenant/bot — last $__rate_interval",
      "id": 11,
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
      "options": { "orientation": "horizontal", "displayMode": "lcd" },
      "targets": [
        {
          "expr": "topk(10, increase(guardrail_decisions_total{outcome=\"block_input_only\"}[$__rate_interval]) by (tenant,bot))",
          "legendFormat": "{{tenant}}/{{bot}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Redactions per minute",
      "id": 12,
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
      "fieldConfig": { "defaults": { "unit": "ops" }, "overrides": [] },
      "targets": [
        {
          "expr": "sum(rate(guardrail_egress_redactions_total[$__rate_interval]))",
          "legendFormat": "redactions/s",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Rate-limited requests (by tenant/bot)",
      "id": 13,
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
      "fieldConfig": { "defaults": { "unit": "ops" }, "overrides": [] },
      "targets": [
        {
          "expr": "sum by (tenant,bot) (rate(guardrail_rate_limited_total[$__rate_interval]))",
          "legendFormat": "{{tenant}}/{{bot}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Active rate-limit backend",
      "id": 14,
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 16 },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } },
      "targets": [
        {
          "expr": "guardrail_ratelimit_backend_in_use",
          "legendFormat": "{{backend}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Redis script reloads (NOSCRIPT) — last $__rate_interval",
      "id": 15,
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 16 },
      "options": { "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false } },
      "targets": [
        {
          "expr": "increase(guardrail_ratelimit_redis_script_reload_total[$__rate_interval])",
          "legendFormat": "reloads",
          "refId": "A"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Policy version (current)",
      "id": 16,
      "gridPos": { "h": 4, "w": 12, "x": 12, "y": 16 },
      "options": { "reduceOptions": { "calcs": ["last"], "fields": "", "values": false } },
      "targets": [
        {
          "expr": "max_over_time(guardrail_policy_version{version!=\"\"}[1h])",
          "legendFormat": "version",
          "refId": "A"
        }
      ]
    }
  ]
}
