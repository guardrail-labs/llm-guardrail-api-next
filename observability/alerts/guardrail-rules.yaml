groups:
  - name: guardrail-api.rules
    interval: 30s
    rules:
      # Service up (scrape target)
      - alert: GuardrailRouteDown
        expr: up{job="guardrail"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Guardrail target is down"
          description: "Prometheus cannot scrape the Guardrail API target for >2m."

      # High 5xx rate
      - alert: GuardrailServerErrorsHigh
        expr: sum(rate(guardrail_requests_total{status=~"5.."}[5m])) > 1
        for: 10m
        labels:
          severity: high
        annotations:
          summary: "Guardrail 5xx elevated"
          description: "5xx rate exceeded 1 req/s for 10m."

      # Elevated 429 / throttling
      - alert: GuardrailThrottlingElevated
        expr: sum(rate(guardrail_requests_total{status="429"}[5m])) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Guardrail throttling elevated"
          description: "429 Too Many Requests sustained >2 req/s for 10m."

      # Latency SLO breach (p95)
      - alert: GuardrailLatencyP95Breached
        expr: histogram_quantile(0.95, sum by (le) (rate(guardrail_request_latency_ms_bucket[5m]))) > 300
        for: 10m
        labels:
          severity: high
        annotations:
          summary: "Guardrail p95 latency > 300ms"
          description: "Sustained p95 latency breach for 10m."

      # Cardinality overflow watch
      - alert: GuardrailMetricsOverflowHigh
        expr: 100 * sum(rate(guardrail_requests_total{tenant="__overflow__"}[5m])) / sum(rate(guardrail_requests_total[5m])) > 5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Metrics overflow > 5%"
          description: "More than 5% of labeled requests collapsed into overflow for 15m. Increase METRICS_LABEL_CARD_MAX or review tenant/bot churn."
