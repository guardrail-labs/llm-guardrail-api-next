# Admin decisions feed

The admin decisions feed exposes recent guardrail decisions for demos, debugging,
and live monitoring. It combines an in-memory ring buffer for fast lookups with a
streaming interface for Server Sent Events (SSE) and a persistent JSONL audit
log on disk.

## Event schema

Every response from `POST /guardrail/evaluate` emits a structured event with the
following fields:

| Field | Description |
| --- | --- |
| `ts` | Unix epoch seconds when the decision was recorded. |
| `incident_id` | Unique incident identifier (also returned in the HTTP headers). |
| `request_id` | Request identifier supplied by the client or generated by the API. |
| `tenant` | Tenant label derived from `X-Tenant` headers or request state. |
| `bot` | Bot label derived from `X-Bot` headers or request state. |
| `family` | High-level decision family (`allow` or `deny`). |
| `mode` | Final enforcement mode (`allow`, `execute_locked`, `deny`, or `full_quarantine`). |
| `status` | HTTP status code returned to the caller. |
| `endpoint` | Matched route pattern for the request (e.g. `/guardrail/evaluate`). |
| `rule_ids` | List of rule identifiers associated with the decision. |
| `policy_version` | Policy version string attached to the response headers. |
| `latency_ms` | Optional latency emitted by the hardened verifier integration. |

Events are stored in a ring buffer capped at `DECISIONS_BUFFER_MAX` entries (default `2000`).
The same events are appended to a JSONL audit file for persistence, controlled by
`DECISIONS_AUDIT_PATH` (default `var/decisions.jsonl`).

## API endpoints

All endpoints require admin authentication (`ADMIN_UI_TOKEN` bearer or basic auth).
Filters are supplied via query parameters (`tenant`, `bot`, `family`, `mode`, `rule_id`, `since`).

- `GET /admin/decisions` – Returns JSON, newest first. Supports `limit` (default 200, max 2000).
- `GET /admin/decisions/stream` – Server Sent Events stream, honoring the same filters.
  - The stream starts with a short snapshot (`event: init`) followed by live `message` events.
- `GET /admin/decisions/export.csv` – Downloads the filtered results as CSV.

## Admin UI

The `/admin/ui/decisions` page consumes these endpoints. It offers:

- Filter inputs for tenant, bot, family, mode, and rule ID.
- A "Live" toggle to pause/resume the SSE stream.
- A CSV export link that mirrors the current filters.
- Click-to-copy for the Incident ID column (hover shows the request ID).

When "Live" is enabled the table prepends new rows in real time. The table keeps
up to 200 rows; older rows are dropped as new events arrive.

## Configuration

Two environment variables control buffering and persistence:

- `DECISIONS_BUFFER_MAX` – Maximum number of events to keep in memory (default `2000`).
- `DECISIONS_AUDIT_PATH` – Destination JSONL file for persisted events (default `var/decisions.jsonl`).

Both values can be overridden at runtime by calling
`app.services.decisions_bus.configure(...)` (used in tests).
